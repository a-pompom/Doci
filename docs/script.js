!function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);var i={};s.r(i),s.d(i,"FocusMode",(function(){return l})),s.d(i,"FocusAngle",(function(){return d}));var n={};s.r(n),s.d(n,"ShapeType",(function(){return _}));var o={};s.r(o),s.d(o,"DrawMode",(function(){return x})),s.d(o,"DrawType",(function(){return g})),s.d(o,"KeyCode",(function(){return v})),s.d(o,"MENU_WIDTH",(function(){return p}));var c={};s.r(c),s.d(c,"Direction",(function(){return m}));var a={};s.r(a),s.d(a,"StackLength",(function(){return y})),s.d(a,"StackWidth",(function(){return f})),s.d(a,"StackHeightCoefficient",(function(){return T})),s.d(a,"StackScaleCoefficient",(function(){return w})),s.d(a,"StackKeyCode",(function(){return E}));var h={};s.r(h),s.d(h,"CSS_Class",(function(){return S}));var r={};s.r(r),s.d(r,"cellColors",(function(){return C})),s.d(r,"cellScale",(function(){return M}));var u={};s.r(u),s.d(u,"InitialScale",(function(){return D})),s.d(u,"TextMarginHeight",(function(){return b})),s.d(u,"DOMTextXCoefficient",(function(){return I})),s.d(u,"DOMTextYCoefficient",(function(){return F}));const l={NONE:Symbol("focus-none"),BORDER:Symbol("border"),INSIDE:Symbol("inside")},d={TOP:Symbol("top"),RIGHT:Symbol("right"),BOTTOM:Symbol("bottom"),LEFT:Symbol("left"),NONE:Symbol("none-focused")},_={SHAPE:Symbol("shape-type-shape"),TEXT:Symbol("shape-type-text")},x={NONE:Symbol("draw-mode-none"),MOVE:Symbol("draw-mode-move"),DELETE:Symbol("draw-mode-delete"),RECTANGLE:Symbol("draw-mode-rect"),TEXT:Symbol("draw-mode-text"),WORD_BALLOON:Symbol("draw-mode-balloon"),IMAGE:Symbol("draw-mode-image")},g={NONE:Symbol("draw-type-none"),RECTANGLE:Symbol("draw-type-rectangle"),TEXT:Symbol("draw-type-text"),IMAGE:Symbol("draw-type-image")},v={Key_R:82,Key_T:84,Key_W:87,Key_I:73,Key_M:77,Key_D:68,Key_C:67},p=160,m={FORWARD:Symbol("forward"),BETWEEN:Symbol("between"),REVERSE:Symbol("reverse")},y=9,f=80,T=20,w={base:11,ratio:8},E={Key_1:49,Key_2:50,Key_3:51,Key_4:52,Key_5:53,Key_6:54,Key_7:55,Key_8:56,Key_9:57},S={INVISIBLE:"invisible",VISIBLE:"visible",ACTIVE_STACK:"active-stack",ACTIVE_MENU:"active-menu"},C={background:"#FFFFFF",border:"#D4D4D4",text:"#000000"},M={x:51.5,y:17},D=20,b=10,I=20,F=80,k={focus:i,shape:n,menu:o,resize:c,stack:a,cssClass:h,excel:r,text:u};class O{static isTextInputMode(){let t=!1;return document.querySelectorAll("textarea, input[type=text]").forEach(e=>{t||(t=document.activeElement===e)}),t}static activateClass(t,e){document.getElementById(t).classList.add(e)}static deactivateClass(t,e){document.getElementById(t).classList.remove(e)}static getPixelRatio(){return window.devicePixelRatio+.4*window.devicePixelRatio}}class A{constructor(){this._stack=[],this._currentIndex=-1}append(t){this._stack.push(t),this._currentIndex=this._stack.length-1}pop(){this._stack.pop(),this._currentIndex--}getCurrent(){return-1===this._currentIndex?this._stack[this._stack.length-1]:this._stack[this._currentIndex]}getByIndex(t){return this._stack[t]}delete(t){this._stack=this._stack.filter((e,s)=>s!==t)}draw(){this._stack.forEach(t=>{t.draw()})}get stack(){return this._stack}}class B{constructor(t){this._context=t}isTheModeActive(t){return this._context.menu.activeMode===t}setupEvent(t,e){}getDrawingShape(){return this._context.focus.isFocused()?this.getFocusedShape():this._context.drawStack.getCurrent()}getFocusedShape(){return this._context.drawStack.getByIndex(this._context.focus.focusedIndex)}getCanvasX(t){return t-this._context.canvas.getBoundingClientRect().left}getCanvasY(t){return t-this._context.canvas.getBoundingClientRect().top}}class R extends B{constructor(t){super(t)}setupEvent(t,e){this[`${t}Event`].call(this,e)}mousemoveEvent(t){if(this._context.isMousedown)return;const e=this._context.drawStack.stack;this._context.focus.inspectShapeFocus(e,this.getCanvasX(t.clientX),this.getCanvasY(t.clientY))}}class L extends B{constructor(t){super(t),this._moveStartX=0,this._moveStartY=0}setupEvent(t,e){this.isTheModeActive(k.menu.DrawMode.MOVE)&&this._context.focus.isFocused()&&this[`${t}Event`].call(this,e)}mousedownEvent(t){this._context.isMousedown=!0,this._moveStartX=this.getCanvasX(t.clientX),this._moveStartY=this.getCanvasY(t.clientY)}mousemoveEvent(t){if(!this._context.isMousedown)return;const e=this.getDrawingShape(),s=this.getCanvasX(t.clientX),i=this.getCanvasY(t.clientY);this.move(e,s,i)}mouseupEvent(){this._context.focus.outFocus(),this._context.isMousedown=!1,this._moveStartX=0,this._moveStartY=0}move(t,e,s){const i=e-this._moveStartX,n=s-this._moveStartY;t.x+=i,t.y+=n,t.fullDraw(),this._moveStartX=e,this._moveStartY=s}}class z{constructor(t){this._context=t}fullDraw(){this.drawBase()}drawBase(){this.clear(),this.drawStack()}drawStack(){this._context.drawStack.draw()}clear(){const t=this._context.canvas.width,e=this._context.canvas.height;this._context.canvasContext.clearRect(0,0,t,e),this.drawBackground()}drawBackground(){this._context.canvasContext.fillStyle=k.excel.cellColors.background,this._context.canvasContext.fillRect(0,0,this._context.canvas.width,this._context.canvas.height);let t=document.getElementById("cellWidth").value,e=document.getElementById("cellHeight").value;if(""===t||""===e)return void(this._context.canvasContext.fillStyle=k.excel.cellColors.text);t=parseFloat(t),e=parseFloat(e);let s=0,i=0;for(this._context.canvasContext.strokeStyle=k.excel.cellColors.border;i<this._context.canvas.height;)this._context.canvasContext.beginPath(),this._context.canvasContext.moveTo(0,i),this._context.canvasContext.lineTo(this._context.canvas.width,i),this._context.canvasContext.closePath(),this._context.canvasContext.stroke(),i+=e*O.getPixelRatio();for(;s<this._context.canvas.width;)this._context.canvasContext.beginPath(),this._context.canvasContext.moveTo(s,0),this._context.canvasContext.lineTo(s,this._context.canvas.height),this._context.canvasContext.closePath(),this._context.canvasContext.stroke(),s+=t*O.getPixelRatio();this._context.canvasContext.fillStyle=k.excel.cellColors.text}}class N{constructor(t,e,s){this._context=t,this._shapeFunction=new z(this._context),this._x=e,this._y=s,this._width=0,this._height=0,this._originX=e,this._originY=s,this._originWidth=0,this._originHeight=0,this._hasArea=!1,this._canIncludeText=!1,this._resizable=!0,this._shapeType=k.shape.ShapeType.SHAPE}fullDraw(){this._shapeFunction.fullDraw()}drawBase(){this._shapeFunction.drawBase()}setOriginPos(){this._originX=this._x,this._originY=this._y}setOriginScale(){this._originWidth=this._width,this._originHeight=this._height}defineAttribute(){}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}get originX(){return this._originX}get originY(){return this._originY}set originX(t){this._originX=t}set originY(t){this._originY=t}get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}get originWidth(){return this._originWidth}get originHeight(){return this._originHeight}get color(){return this._color}get hasArea(){return this._hasArea}get canIncludeText(){return this._canIncludeText}get resizable(){return this._resizable}get shapeType(){return this._shapeType}}class X extends N{constructor(t){super(t,-1,-1)}draw(t,e,s){t.apply(e,s)}}class H extends B{constructor(t){super(t),this._metaShape=new X(t)}setupEvent(t,e){this.isTheModeActive(k.menu.DrawMode.DELETE)&&this._context.focus.isFocused()&&this[`${t}Event`].call(this,e)}clickEvent(t){this.delete()}delete(){const t=this._context.focus.focusedIndex;this._context.drawStack.delete(t),this._context.focus.outFocus(),this._metaShape.draw(this._metaShape.drawBase,this._metaShape)}}class K extends class{constructor(t,e,s){this._context=t,this._shapeFunction=new z(this._context),this._originTextDOM=document.getElementById("inputText"),this._originText="",this._x=e,this._y=s,this._width=0,this._height=0,this._hasArea=!1,this._canIncludeText=!1,this._resizable=!1,this._shapeType=k.shape.ShapeType.TEXT}fullDraw(){this._shapeFunction.fullDraw()}drawBase(){this._shapeFunction.drawBase()}defineAttribute(){}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}get hasArea(){return this._hasArea}get canIncludeText(){return this._canIncludeText}get resizable(){return this._resizable}get shapeType(){return this._shapeType}}{constructor(t,e,s,i){super(t,e,s),this.defineAttribute(),this._text=[],this._boxWidth=i||t.canvas.width-e,this._textSize=18,this.init()}init(){this._originTextDOM.value="",this._originTextDOM.style.width=`${k.text.InitialScale}px`,this._originTextDOM.style.height=`${k.text.InitialScale}px`,this._originTextDOM.focus(),this._context.canvasContext.font=`normal normal 100 ${this._textSize}px sans-serif`,this.width=k.text.InitialScale,this.height=k.text.InitialScale}draw(){this._text.forEach((t,e)=>{this._context.canvasContext.fillText(t,this.x,this.y+e*k.text.InitialScale)})}updatePos(t,e){this.x=t+k.text.InitialScale,this.y=e+k.text.InitialScale+k.text.TextMarginHeight}update(){this._originText=this._originTextDOM.value,this._text=[],this._originText.split(/\r?\n/g).forEach(t=>{for(;this.isOverFit(this.getFragmentTextWidth(t));){let e=this.getFittedTailIndex(t);this._text.push(t.substring(0,e)),t=t.substring(e)}this._text.push(t)}),this._text.forEach(t=>{let e=this.getFragmentTextWidth(t);this.width=e>=this.width?e:this.width}),this.height=(this._text.length+1)*(k.text.InitialScale+k.text.TextMarginHeight),this._originTextDOM.style.width=`${this.width+k.text.InitialScale}px`,this._originTextDOM.style.height=`${this.height}px`,this._originTextDOM.focus()}getFittedTailIndex(t){let e=0;for(;!this.isOverFit(this.getFragmentTextWidth(t.substring(0,e)));)e++;return e-1}isOverFit(t){return t>=this._boxWidth-k.text.InitialScale}getFragmentTextWidth(t){return this._context.canvasContext.measureText(t).width}defineAttribute(){this._hasArea=!0}get text(){return this._text}get originText(){return this._originText}}class P{constructor(t,e){this._context=t,this._originTextDOM=e}handleClickEvent(t){this.setTextDOMAttribute(t),this._originTextDOM.value=t.originText,this._originTextDOM.focus()}handleBoxClickEvent(t){this.setTextDOMAttribute(t),this._originTextDOM.value=t.boxText.originText,this._originTextDOM.focus()}handleKeyEvent(t){t.canIncludeText?t.boxText.update():t.update()}handleBlurEvent(t){this.teardown(t),this._originTextDOM.style.top=0,this._originTextDOM.style.left=0,this._originTextDOM.style.width=0,this._originTextDOM.style.height=0,this._originTextDOM.value="",this._originTextDOM.blur()}teardown(){const t=this._context.drawStack.getCurrent();let e=!1;if(t.canIncludeText)return e=""===t.boxText.originText,e?void(t.boxText=null):void t.fullDraw();e=""===t.originText,e?this._context.drawStack.pop():t.fullDraw()}setTextDOMAttribute(t){if(t.canIncludeText)return this.setTextDOMPos(t.x+k.text.InitialScale,t.y+k.text.InitialScale+k.text.TextMarginHeight),void this.setTextDOMScale(t.width-k.text.InitialScale,t.height-(k.text.InitialScale+k.text.TextMarginHeight));this.setTextDOMPos(t.x,t.y),this.setTextDOMScale(t.width,t.height)}setTextDOMPos(t,e){this._originTextDOM.style.top=`${e-k.text.DOMTextXCoefficient}px`,this._originTextDOM.style.left=`${t+k.text.DOMTextYCoefficient}px`}setTextDOMScale(t,e){this._originTextDOM.style.width=`${t}px`,this._originTextDOM.style.height=`${e}px`}}class W extends B{constructor(t){super(t),this._originTextDOM=document.getElementById("inputText"),this._service=new P(this._context,this._originTextDOM),this._blurKeyCode=27,this.init()}init(){this._originTextDOM.addEventListener("keydown",t=>{this.setupEvent("keydown",t)}),this._originTextDOM.addEventListener("blur",t=>{this.blurEvent(t)})}setupEvent(t,e){this.isTheModeActive(k.menu.DrawMode.TEXT)&&this[`${t}Event`].call(this,e)}clickEvent(t){if(document.activeElement===this._originTextDOM)return;if(!this._context.focus.isFocused()){const e=new K(this._context,this.getCanvasX(t.clientX),this.getCanvasY(t.clientY));return this._service.handleClickEvent(e),void this._context.drawStack.append(e)}const e=this.getDrawingShape();e.shapeType!==k.shape.ShapeType.TEXT?e.canIncludeText&&this._context.focus.focusMode===k.focus.FocusMode.INSIDE&&(null===e.boxText&&(e.boxText=new K(this._context,e.x,e.y,e.width)),this._service.handleBoxClickEvent(e)):this._service.handleClickEvent(e)}keydownEvent(t){if(t.keyCode===this._blurKeyCode)return this._service.handleKeyEvent(this.getDrawingShape()),void this._originTextDOM.blur();this._service.handleKeyEvent(this.getDrawingShape())}blurEvent(){this._service.handleBlurEvent(this.getDrawingShape())}}class Y extends N{constructor(t,e,s){super(t,e,s),this.defineAttribute(),this._color="#FF0000"}draw(){this._context.canvasContext.strokeStyle=this._color,this._context.canvasContext.strokeRect(this.x,this.y,this.width,this.height)}defineAttribute(){this._resizable=!0,this._hasArea=!1}}class $ extends N{constructor(t,e,s){super(t,e,s),this.defineAttribute(),this._color="#FF0000",this._fillColor="#FFFFFF",this._textColor="#000000",this._boxText=null}draw(){this._context.canvasContext.fillStyle=this._fillColor,this._context.canvasContext.fillRect(this.x,this.y,this.width,this.height),this._context.canvasContext.strokeStyle=this._color,this._context.canvasContext.strokeRect(this.x,this.y,this.width,this.height),this.drawTail(),this._context.canvasContext.fillStyle=this._textColor,null!==this._boxText&&(this._boxText.updatePos(this.x,this.y),this._boxText.draw())}drawTail(){const t=this.x+.1*this.width,e=this.x+.3*this.width,s=this.y+this.height,i=this.y+this.height+.2*this.height;this._context.canvasContext.beginPath(),this._context.canvasContext.moveTo(t,s),this._context.canvasContext.lineTo(t,i),this._context.canvasContext.lineTo(e,s),this._context.canvasContext.lineTo(t,s),this._context.canvasContext.closePath(),this._context.canvasContext.fillStyle=this._fillColor,this._context.canvasContext.fill(),this._context.canvasContext.strokeStyle=this._color,this._context.canvasContext.stroke();this._context.canvasContext.strokeStyle=this._fillColor,this._context.canvasContext.beginPath(),this._context.canvasContext.moveTo(t,s),this._context.canvasContext.lineTo(e-2,s),this._context.canvasContext.closePath();for(let t=0;t<10;t++)this._context.canvasContext.stroke()}defineAttribute(){this._canIncludeText=!0,this._hasArea=!0}updateText(){this._boxText.update()}get boxText(){return this._boxText}set boxText(t){this._boxText=t}}class V{constructor(){this._shape=null}updatePos(t,e,s){const i=this.isYFocused(s),n=this.isXFocused(s);this._shape.x=i?this._shape.originX:t,this._shape.y=n?this._shape.originY:e}isXFocused(t){return!(t.length>1)&&(t[0]===k.focus.FocusAngle.LEFT||t[0]===k.focus.FocusAngle.RIGHT)}isYFocused(t){return!(t.length>1)&&(t[0]===k.focus.FocusAngle.TOP||t[0]===k.focus.FocusAngle.BOTTOM)}modifyScale(t,e,s){s.forEach(s=>{if(s===k.focus.FocusAngle.NONE&&(this._shape.width=t,this._shape.height=e),s===k.focus.FocusAngle.BOTTOM&&(this._shape.height=e),s===k.focus.FocusAngle.TOP)switch(this.getScaleDirection(e,"y")){case k.resize.Direction.FORWARD:this._shape.height=e+this._shape.originHeight;break;case k.resize.Direction.BETWEEN:this._shape.y=this._shape.originY+e,this._shape.height=this._shape.originHeight-e;break;case k.resize.Direction.REVERSE:this._shape.y=this._shape.originY+this._shape.originHeight,this._shape.height=e-this._shape.originHeight}if(s===k.focus.FocusAngle.RIGHT&&(this._shape.width=t),s===k.focus.FocusAngle.LEFT)switch(this.getScaleDirection(t,"x")){case k.resize.Direction.FORWARD:this._shape.width=t+this._shape.originWidth;break;case k.resize.Direction.BETWEEN:this._shape.x=this._shape.originX+t,this._shape.width=this._shape.originWidth-t;break;case k.resize.Direction.REVERSE:this._shape.x=this._shape.originX+this._shape.originWidth,this._shape.width=t-this._shape.originWidth}})}getScaleDirection(t,e){const s=this._shape[`${e}`],i=this._shape[`origin${e.toUpperCase()}`],n="x"===e?this._shape.originWidth:this._shape.originHeight;return s!==i?k.resize.Direction.FORWARD:t<=n?k.resize.Direction.BETWEEN:k.resize.Direction.REVERSE}set shape(t){this._shape=t}}class G{constructor(t){this._context=t,this._resizeHandler=new V}initResizeEvent(t){t.setOriginPos(),t.setOriginScale()}resize(t,e,s){this._resizeHandler.shape=t;const i=e>=t.originX?t.originX:e,n=s>=t.originY?t.originY:s;this._resizeHandler.updatePos(i,n,this._context.focus.focusedAngle);const o=Math.abs(t.originX-e),c=Math.abs(t.originY-s);this._resizeHandler.modifyScale(o,c,this._context.focus.focusedAngle)}}class U extends B{constructor(t){super(t),this._resizeService=new G(t)}setupEvent(t,e){if(this.isRectangleActive()){if(this._context.focus.isFocused()){if(!this.getDrawingShape().resizable)return}this._context.focus.focusMode===k.focus.FocusMode.INSIDE&&this._context.focus.outFocus(),this[`${t}Event`].call(this,e)}}mousedownEvent(t){if(this._context.isMousedown=!0,this._context.focus.isFocused())this._resizeService.initResizeEvent(this.getDrawingShape());else{const e=this.getRectangle(this.getCanvasX(t.clientX),this.getCanvasY(t.clientY));this._context.drawStack.append(e)}}mousemoveEvent(t){if(!this._context.isMousedown)return;const e=this.getDrawingShape(),s=this.getCanvasX(t.clientX),i=this.getCanvasY(t.clientY);this._resizeService.resize(e,s,i),e.fullDraw()}mouseupEvent(){this._context.focus.outFocus(),this._context.isMousedown=!1}isRectangleActive(){return this._context.menu.activeType===k.menu.DrawType.RECTANGLE}getRectangle(t,e){return this._context.menu.activeMode===k.menu.DrawMode.RECTANGLE?new Y(this._context,t,e):this._context.menu.activeMode===k.menu.DrawMode.WORD_BALLOON?new $(this._context,t,e):void 0}}class j extends N{constructor(t,e,s,i){super(t,e,s),this._ratio=1,i.width>t.canvas.width/O.getPixelRatio()&&(this._ratio=t.canvas.width/O.getPixelRatio()/i.width),i.height>t.canvas.height/O.getPixelRatio()&&(this._ratio=t.canvas.height/O.getPixelRatio()/i.height),this.width=i.width*this._ratio,this.height=i.height*this._ratio,this._imageSource=i,this.defineAttribute()}draw(){this._context.canvasContext.drawImage(this._imageSource,this.x,this.y,this.width,this.height)}defineAttribute(){this._hasArea=!1}}class q extends B{constructor(t){super(t),this._posX=0,this._posY=0,this._resizeService=new G(t),this.init()}init(){document.addEventListener("paste",t=>{this.pasteEvent(t)})}setupEvent(t,e){if(!this.isTheModeActive(k.menu.DrawMode.IMAGE))return;if(this._posX=this.getCanvasX(e.clientX),this._posY=this.getCanvasY(e.clientY),!this._context.focus.isFocused())return;this.getDrawingShape().resizable&&this[`${t}Event`].call(this,e)}pasteEvent(t){const e=t.clipboardData.items[0];e.type.includes("image")&&this.createImage(e)}mousedownEvent(t){this._context.isMousedown=!0,this._resizeService.initResizeEvent(this.getDrawingShape())}mousemoveEvent(t){if(!this._context.isMousedown)return;const e=this.getCanvasX(t.clientX),s=this.getCanvasY(t.clientY),i=this.getDrawingShape();this._resizeService.resize(i,e,s),i.fullDraw()}mouseupEvent(){this._context.isMousedown=!1,this._context.focus.outFocus()}createImage(t){const e=new Image,s=t.getAsFile(),i=window.URL.createObjectURL(s);e.onload=()=>{const t=new j(this._context,this._posX,this._posY,e);this._context.drawStack.append(t),t.fullDraw()},e.src=i}}class J extends B{constructor(t){super(t)}setupEvent(t,e){this[`${t}Event`].call(this,e)}mousemoveEvent(t){this.resetCursor(),this.inspect()}inspect(){[{event:"Text",mode:k.menu.DrawMode.TEXT},{event:"Move",mode:k.menu.DrawMode.MOVE},{event:"Delete",mode:k.menu.DrawMode.DELETE},{event:"Resize",mode:null}].forEach(t=>{null!==t.mode&&this._context.menu.activeMode!==t.mode||this[`inspect${t.event}`].call(this)})}resetCursor(){this._context.canvas.style.cursor="default"}inspectText(){if(!this._context.focus.isFocused())return;const t=this.getDrawingShape();this._context.focus.focusMode===k.focus.FocusMode.INSIDE&&t.canIncludeText?this._context.canvas.style.cursor="text":t.shapeType!==k.shape.ShapeType.TEXT||(this._context.canvas.style.cursor="text")}inspectMove(){this._context.focus.isFocused()&&(this._context.isMousedown?this._context.canvas.style.cursor="grabbing":this._context.canvas.style.cursor="grab")}inspectDelete(){this._context.focus.isFocused()&&(this._context.canvas.style.cursor="grabbing")}inspectResize(){if(this._context.focus.focusMode!==k.focus.FocusMode.BORDER)return;if(!this._context.menu.activeResizable)return;this.getDrawingShape().resizable&&(this.inspectDualDirectionResize(),this.inspectSingleDirectionResize())}inspectSingleDirectionResize(){if(1!==this._context.focus.focusedAngle.length)return;const t=this.isDirectionFocused(k.focus.FocusAngle.TOP)||this.isDirectionFocused(k.focus.FocusAngle.BOTTOM),e=this.isDirectionFocused(k.focus.FocusAngle.LEFT)||this.isDirectionFocused(k.focus.FocusAngle.RIGHT);t?this._context.canvas.style.cursor="row-resize":e&&(this._context.canvas.style.cursor="col-resize")}inspectDualDirectionResize(){if(2!==this._context.focus.focusedAngle.length)return;const t=this.isDirectionFocused(k.focus.FocusAngle.TOP),e=this.isDirectionFocused(k.focus.FocusAngle.BOTTOM),s=this.isDirectionFocused(k.focus.FocusAngle.LEFT),i=this.isDirectionFocused(k.focus.FocusAngle.RIGHT),n=t&&i,o=e&&s;t&&s||e&&i?this._context.canvas.style.cursor="nwse-resize":(n||o)&&(this._context.canvas.style.cursor="nesw-resize")}isDirectionFocused(t){return this._context.focus.focusedAngle.includes(t)}}class Q extends B{constructor(t){super(t),this._cellWidthDOM=document.getElementById("cellWidth"),this._cellHeightDOM=document.getElementById("cellHeight"),this._metaShape=new X(t),this.init()}init(){this._cellWidthDOM.addEventListener("blur",()=>{this.validateValue(),this._metaShape.draw(this._metaShape.drawBase,this._metaShape)}),this._cellHeightDOM.addEventListener("blur",()=>{this.validateValue(),this._metaShape.draw(this._metaShape.drawBase,this._metaShape)})}setupEvent(t,e){}validateValue(){const t=this._cellWidthDOM.value,e=this._cellHeightDOM.value;if(""===t||""===e)return;const s=!isNaN(parseFloat(t))&&isFinite(t)&&parseFloat(t)>0,i=!isNaN(parseFloat(e))&&isFinite(e)&&parseFloat(e)>0;s&&i||(this._cellWidthDOM.value="",this._cellHeightDOM.value="")}}class Z{constructor(t){this._context=t,this._KeyCode=k.menu.KeyCode.Key_C,this.init()}init(){document.getElementById("canvasToClipboardButton").addEventListener("click",t=>{this.setClipBoard()}),document.addEventListener("keydown",t=>{O.isTextInputMode()||t.keyCode!==this._KeyCode||this.setClipBoard()})}setClipBoard(){this.getClipCanvas().toBlob(t=>{const e=new ClipboardItem({[t.type]:t});navigator.clipboard.write([e]),this.showCopiedMessage()},"image/png",1)}showCopiedMessage(){const t=document.getElementById("copiedMessage");t.classList.remove(k.cssClass.CSS_Class.INVISIBLE),setTimeout(()=>{t.classList.add(k.cssClass.CSS_Class.INVISIBLE)},500)}getClipCanvas(){const t=document.createElement("canvas"),e=t.getContext("2d");return t.width=this._context.canvas.width/O.getPixelRatio(),t.height=this._context.canvas.height/O.getPixelRatio(),e.drawImage(this._context.canvas,0,0,t.width,t.height),t}}class tt{constructor(t){this._context=t,this._currentStack=0,this._stackScale=0,this._metaShape=new X(this._context),this.init()}init(){this.initDOMScale();for(let t=0;t<k.stack.StackLength;t++){document.getElementById(`stackButton-${t}`).addEventListener("click",()=>{this.registerHandleEvent(t)}),document.addEventListener("keydown",e=>{O.isTextInputMode()||e.keyCode!==k.stack.StackKeyCode[`Key_${t+1}`]||this.registerHandleEvent(t)})}}initDOMScale(){const t=document.body.clientHeight,e=k.stack.StackScaleCoefficient.base,s=k.stack.StackScaleCoefficient.ratio;this._stackScale=t/(e+s/O.getPixelRatio());for(let t=0;t<k.stack.StackLength;t++){const e=document.getElementById(`stackButton-${t}`);e.style.width=`${k.stack.StackWidth}px`,e.style.height=`${this._stackScale+k.stack.StackHeightCoefficient}px`;const s=document.getElementById(`image-${t}`);s.width=k.stack.StackWidth,s.height=this._stackScale}}registerHandleEvent(t){0!==this._context.drawStackList[this._currentStack].length&&this.createThumbNail(this._currentStack),this._currentStack!==t&&(O.deactivateClass(`image-cap-${this._currentStack}`,"active-stack"),this._context.drawStack=this._context.drawStackList[t],this._currentStack=t,O.activateClass(`image-cap-${this._currentStack}`,"active-stack"),this._context.focus.outFocus(),this._metaShape.draw(this._metaShape.drawBase,this._metaShape),0!==this._context.drawStack.stack.length&&this._context.drawStack.draw())}createThumbNail(t){const e=this._context.canvas.toDataURL();document.getElementById(`image-${t}`).src=e}activate(t){document.getElementById(`image-${t}`).classList.add(k.cssClass.CSS_Class.ACTIVE_STACK)}deactivate(t){document.getElementById(`image-${t}`).classList.remove(k.cssClass.CSS_Class.ACTIVE_STACK)}}class et{constructor(){this._activeMode=k.menu.DrawMode.NONE,this._activeType=k.menu.DrawType.NONE,this._activeIndex=0,this._activeResizable=!1,this._messageForFocusDOM=document.getElementById("focusText"),this._menuList=[{element:document.getElementById("rectangleModeButton"),mode:k.menu.DrawMode.RECTANGLE,type:k.menu.DrawType.RECTANGLE,index:0,resizable:!0,keyCode:k.menu.KeyCode.Key_R},{element:document.getElementById("textModeButton"),mode:k.menu.DrawMode.TEXT,type:k.menu.DrawType.TEXT,index:1,resizable:!1,keyCode:k.menu.KeyCode.Key_T},{element:document.getElementById("wordBalloonModeButton"),mode:k.menu.DrawMode.WORD_BALLOON,type:k.menu.DrawType.RECTANGLE,index:2,resizable:!0,keyCode:k.menu.KeyCode.Key_W},{element:document.getElementById("imageModeButton"),mode:k.menu.DrawMode.IMAGE,type:k.menu.DrawType.IMAGE,index:3,resizable:!0,keyCode:k.menu.KeyCode.Key_I},{element:document.getElementById("moveModeButton"),mode:k.menu.DrawMode.MOVE,type:k.menu.DrawType.NONE,index:4,resizable:!1,keyCode:k.menu.KeyCode.Key_M},{element:document.getElementById("deleteModeButton"),mode:k.menu.DrawMode.DELETE,type:k.menu.DrawType.NONE,index:5,resizable:!1,keyCode:k.menu.KeyCode.Key_D}],this.initMenu(),this.initShortCutInfo()}initMenu(){this._menuList.forEach(t=>{t.element.addEventListener("click",()=>{this.registerHandleEvent(t)}),document.addEventListener("keydown",e=>{O.isTextInputMode()||e.keyCode!==t.keyCode||this.registerHandleEvent(t)})})}initShortCutInfo(){const t=document.getElementById("shortCutMenu"),e=document.getElementById("shortCutTips");e.addEventListener("mouseover",()=>{t.classList.remove(k.cssClass.CSS_Class.INVISIBLE)}),e.addEventListener("mouseout",()=>{t.classList.add(k.cssClass.CSS_Class.INVISIBLE)})}registerHandleEvent(t){O.deactivateClass(this._menuList[this._activeIndex].element.id,k.cssClass.CSS_Class.ACTIVE_MENU),this._activeMode=t.mode,this._activeType=t.type,this._activeResizable=t.resizable,this._activeIndex=t.index,O.activateClass(t.element.id,k.cssClass.CSS_Class.ACTIVE_MENU)}get activeMode(){return this._activeMode}get activeType(){return this._activeType}get activeResizable(){return this._activeResizable}}class st{constructor(){this._focusedIndex=-1,this._focusedAngle=[],this._focusMode=k.focus.FocusMode.NONE}inspectShapeFocus(t,e,s){this.outFocus();const i={x:e,y:s};for(let e=t.length-1;e>=0;e--){let s=t[e];if(this.inspectBorderFocus(s,i,e,10),this.isFocused())break;if(s.hasArea&&(this.inspectInsideFocus(s,i,e),this.isFocused()))break}}inspectBorderFocus(t,e,s,i){const n=t.height,o=t.width;e.x>=t.x-i&&e.x<=t.x+i+o&&e.y>=t.y-i&&e.y<=t.y+i&&this.setFocusTarget(s,k.focus.FocusAngle.TOP),e.y>=t.y-i&&e.y<=t.y+i+n&&e.x>=t.x-i&&e.x<=t.x+i&&this.setFocusTarget(s,k.focus.FocusAngle.LEFT),e.y>=t.y-i&&e.y<=t.y+i+n&&e.x>=t.x-i+o&&e.x<=t.x+i+o&&this.setFocusTarget(s,k.focus.FocusAngle.RIGHT),e.x>=t.x-i&&e.x<=t.x+i+o&&e.y>=t.y-i+n&&e.y<=t.y+i+n&&this.setFocusTarget(s,k.focus.FocusAngle.BOTTOM)}inspectInsideFocus(t,e,s){const i=t.height,n=t.width,o=t.x<e.x&&e.x<t.x+n,c=t.y<e.y&&e.y<t.y+i;o&&c&&this.setInsideFocusTarget(s)}setFocusTarget(t,e){this._focusedIndex=t,this._focusedAngle.push(e),this._focusMode=k.focus.FocusMode.BORDER}setInsideFocusTarget(t){this._focusedIndex=t,this._focusMode=k.focus.FocusMode.INSIDE}outFocus(){this._focusedIndex=-1,this._focusedAngle=[],this._focusMode=k.focus.FocusMode.NONE}isFocused(){return-1!==this._focusedIndex}get focusMode(){return this._focusMode}get focusedIndex(){return this._focusedIndex}get focusedAngle(){return this.isFocused()?this._focusedAngle:[k.focus.FocusAngle.NONE]}}class it{constructor(){this._context=this.getContext(),this.init()}getContext(){const t=document.getElementById("myCanvas"),e=t.getContext("2d"),s=this.getDrawStackList(k.stack.StackLength);return{canvas:t,canvasContext:e,isMousedown:!1,currentStack:0,drawStackList:s,drawStack:s[0],menu:new et,focus:new st}}init(){this.inistHandler(),this.setCanvasScale();const t=[new R(this._context),new Q(this._context),new U(this._context),new W(this._context),new q(this._context),new L(this._context),new H(this._context),new J(this._context)];["mousedown","mousemove","mouseup","click"].forEach(e=>{const s=[];t.forEach((t,i)=>{"function"==typeof t[`${e}Event`]&&s.push(i)}),this._context.canvas.addEventListener(e,i=>{s.forEach(s=>{t[s].setupEvent.call(t[s],e,i)})})})}inistHandler(){[Z,tt].forEach(t=>{new t(this._context)})}getDrawStackList(t){let e=[];for(let s=0;s<t;s++)e.push(new A);return e}setCanvasScale(){const t=O.getPixelRatio();this._context.canvas.width=(document.body.clientWidth-k.menu.MENU_WIDTH)*t,this._context.canvas.height=document.body.clientHeight*t,this._context.canvas.style.width=`${document.body.clientWidth-k.menu.MENU_WIDTH}px`,this._context.canvas.style.height=`${document.body.clientHeight}px`,this._context.canvasContext.setTransform(t,0,0,t,0,0)}}({init(){new it}}).init()}]);